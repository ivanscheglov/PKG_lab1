<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Лабораторная 1 — Вариант 11 (XYZ ⇄ LAB ⇄ HLS)</title>
  <style>
    :root{font-family:Inter, system-ui, Arial; color:#111}
    body{margin:18px; background:#fafafa}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    h1{font-size:16px;margin:0;font-weight:600}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .card{background:white;padding:12px;border-radius:8px;box-shadow:0 1px 0 rgba(0,0,0,.04);min-width:0}
    .model-title{font-size:13px;margin:0 0 8px 0;font-weight:600}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .row label{width:38px;font-size:12px}
    input[type=range]{flex:1}
    input[type=number]{width:68px;padding:6px;border:1px solid #ddd;border-radius:6px}
    input[type=color]{width:56px;height:36px;padding:0;border:0;background:none}
    .swatch{height:74px;border-radius:8px;border:1px solid #ddd;box-shadow:inset 0 0 0 1px rgba(0,0,0,.02)}
    .top-controls{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .hint{font-size:12px;color:#666}
    .notice{font-size:12px;color:#b35;background:transparent;padding:6px 8px;border-radius:6px;display:inline-block}
    footer{margin-top:12px;font-size:12px;color:#666}
    /* Minimal, "handmade" look */
    .small{font-size:12px;color:#666}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Вариант 11 — XYZ ↔ LAB ↔ HLS</h1>
    </header>

    <div class="top-controls">
      <input id="colorPicker" type="color" title="Палитра">
      <div style="flex:1">
        <div class="swatch" id="swatch"></div>
      </div>
      <div id="clampNotice" class="small" style="min-width:220px;text-align:right"></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="model-title">XYZ</div>
        <div class="row"><label>X</label><input id="X_range" type="range" min="0" max="95.047" step="0.01"><input id="X_num" type="number" min="0" max="95.047" step="0.01"></div>
        <div class="row"><label>Y</label><input id="Y_range" type="range" min="0" max="100" step="0.01"><input id="Y_num" type="number" min="0" max="100" step="0.01"></div>
        <div class="row"><label>Z</label><input id="Z_range" type="range" min="0" max="108.883" step="0.01"><input id="Z_num" type="number" min="0" max="108.883" step="0.01"></div>
      </div>

      <div class="card">
        <div class="model-title">LAB</div>
        <div class="row"><label>L</label><input id="L_range" type="range" min="0" max="100" step="0.01"><input id="L_num" type="number" min="0" max="100" step="0.01"></div>
        <div class="row"><label>a</label><input id="a_range" type="range" min="-128" max="127" step="0.01"><input id="a_num" type="number" min="-128" max="127" step="0.01"></div>
        <div class="row"><label>b</label><input id="b_range" type="range" min="-128" max="127" step="0.01"><input id="b_num" type="number" min="-128" max="127" step="0.01"></div>
      </div>

      <div class="card">
        <div class="model-title">HLS</div>
        <div class="row"><label>H</label><input id="H_range" type="range" min="0" max="360" step="0.01"><input id="H_num" type="number" min="0" max="360" step="0.01"></div>
        <div class="row"><label>L</label><input id="HL_range" type="range" min="0" max="100" step="0.01"><input id="HL_num" type="number" min="0" max="100" step="0.01"></div>
        <div class="row"><label>S</label><input id="S_range" type="range" min="0" max="100" step="0.01"><input id="S_num" type="number" min="0" max="100" step="0.01"></div>
      </div>
    </div>


  </div>

  <script>
    // Reference white D65
    const REF_X = 95.047, REF_Y = 100.000, REF_Z = 108.883;

    // Elements
    const colorPicker = document.getElementById('colorPicker');
    const swatch = document.getElementById('swatch');
    const clampNotice = document.getElementById('clampNotice');

    // XYZ
    const X_range = document.getElementById('X_range'), X_num = document.getElementById('X_num');
    const Y_range = document.getElementById('Y_range'), Y_num = document.getElementById('Y_num');
    const Z_range = document.getElementById('Z_range'), Z_num = document.getElementById('Z_num');

    // LAB
    const L_range = document.getElementById('L_range'), L_num = document.getElementById('L_num');
    const a_range = document.getElementById('a_range'), a_num = document.getElementById('a_num');
    const b_range = document.getElementById('b_range'), b_num = document.getElementById('b_num');

    // HLS (HSL-like, L in 0..100)
    const H_range = document.getElementById('H_range'), H_num = document.getElementById('H_num');
    const HL_range = document.getElementById('HL_range'), HL_num = document.getElementById('HL_num');
    const S_range = document.getElementById('S_range'), S_num = document.getElementById('S_num');

    // Helpers to sync range + number
    function link(rangeEl, numEl, onChange){
      rangeEl.addEventListener('input', ()=>{ numEl.value = rangeEl.value; onChange(); });
      numEl.addEventListener('input', ()=>{ rangeEl.value = numEl.value; onChange(); });
    }

    // Conversion utilities
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function srgbToLinear(c){ c = c/255; return c<=0.04045 ? c/12.92 : Math.pow((c+0.055)/1.055,2.4); }
    function linearToSrgb(c){ return c<=0.0031308 ? 12.92*c : 1.055*Math.pow(c,1/2.4)-0.055; }

    function rgbToXyz(r,g,b){
      // r,g,b 0..255
      let R = srgbToLinear(r);
      let G = srgbToLinear(g);
      let B = srgbToLinear(b);
      // Observer = 2°, Illuminant = D65
      let X = (R * 0.4124564 + G * 0.3575761 + B * 0.1804375) * 100.0;
      let Y = (R * 0.2126729 + G * 0.7151522 + B * 0.0721750) * 100.0;
      let Z = (R * 0.0193339 + G * 0.1191920 + B * 0.9503041) * 100.0;
      return [X,Y,Z];
    }

    function xyzToRgb(X,Y,Z){
      X/=100; Y/=100; Z/=100;
      let R = X *  3.2404542 + Y * -1.5371385 + Z * -0.4985314;
      let G = X * -0.9692660 + Y *  1.8760108 + Z *  0.0415560;
      let B = X *  0.0556434 + Y * -0.2040259 + Z *  1.0572252;
      R = linearToSrgb(R); G = linearToSrgb(G); B = linearToSrgb(B);
      // Map to 0..255
      return [R*255, G*255, B*255];
    }

    function f_lab(t){ return t>Math.pow(6/29,3) ? Math.cbrt(t) : (t/(3*Math.pow(6/29,2)) + 4/29); }
    function f_lab_inv(t){ return t>6/29 ? t*t*t : 3*Math.pow(6/29,2)*(t - 4/29); }

    function xyzToLab(X,Y,Z){
      let x = f_lab(X/REF_X);
      let y = f_lab(Y/REF_Y);
      let z = f_lab(Z/REF_Z);
      let L = 116*y - 16;
      let a = 500*(x - y);
      let b = 200*(y - z);
      return [L,a,b];
    }

    function labToXyz(L,a,b){
      let y = (L + 16)/116;
      let x = y + a/500;
      let z = y - b/200;
      let X = REF_X * f_lab_inv(x);
      let Y = REF_Y * f_lab_inv(y);
      let Z = REF_Z * f_lab_inv(z);
      return [X,Y,Z];
    }

    // HSL <-> RGB (H:0..360, S,L:0..100)
    function hslToRgb(h,s,l){
      h = h % 360; if(h<0) h+=360;
      s/=100; l/=100;
      if(s===0){ let v = l*255; return [v,v,v]; }
      function hue2rgb(p,q,t){ if(t<0) t+=1; if(t>1) t-=1; if(t<1/6) return p + (q-p)*6*t; if(t<1/2) return q; if(t<2/3) return p + (q-p)*(2/3 - t)*6; return p; }
      let q = l<0.5 ? l*(1+s) : l + s - l*s;
      let p = 2*l - q;
      let hk = h/360;
      let r = hue2rgb(p,q,hk + 1/3);
      let g = hue2rgb(p,q,hk);
      let b = hue2rgb(p,q,hk - 1/3);
      return [r*255,g*255,b*255];
    }

    function rgbToHsl(r,g,b){
      r/=255; g/=255; b/=255;
      let max = Math.max(r,g,b), min = Math.min(r,g,b);
      let h=0, s=0, l=(max+min)/2;
      if(max!==min){
        let d = max-min;
        s = l>0.5 ? d/(2 - max - min) : d/(max + min);
        switch(max){
          case r: h = (g - b)/d + (g < b ? 6 : 0); break;
          case g: h = (b - r)/d + 2; break;
          case b: h = (r - g)/d + 4; break;
        }
        h *= 60;
      }
      return [h, l*100, s*100];
    }

    // Update flow guards
    let updating = false;

    function setColorFromRgb(r,g,b, source){
      // Update swatch and color picker
      let rr = Math.round(clamp(r,0,255)), gg = Math.round(clamp(g,0,255)), bb = Math.round(clamp(b,0,255));
      const hex = '#'+[rr,gg,bb].map(x=>x.toString(16).padStart(2,'0')).join('');
      swatch.style.background = hex;
      colorPicker.value = hex;

      // Compute XYZ -> LAB -> HSL
      const [X,Y,Z] = rgbToXyz(rr,gg,bb);
      const [L,a,b_] = xyzToLab(X,Y,Z);
      const [H,HL,S] = rgbToHsl(rr,gg,bb);

      updating = true;
      // XYZ fields
      X_range.value = X.toFixed(2); X_num.value = X.toFixed(2);
      Y_range.value = Y.toFixed(2); Y_num.value = Y.toFixed(2);
      Z_range.value = Z.toFixed(2); Z_num.value = Z.toFixed(2);
      // LAB
      L_range.value = L.toFixed(2); L_num.value = L.toFixed(2);
      a_range.value = a.toFixed(2); a_num.value = a.toFixed(2);
      b_range.value = b_.toFixed(2); b_num.value = b_.toFixed(2);
      // HLS
      H_range.value = H.toFixed(2); H_num.value = H.toFixed(2);
      HL_range.value = (HL).toFixed(2); HL_num.value = (HL).toFixed(2);
      S_range.value = (S).toFixed(2); S_num.value = (S).toFixed(2);
      updating = false;

      clampNotice.textContent = '';
    }

    function setColorFromXyz(){
      if(updating) return; updating = true;
      let X = parseFloat(X_num.value), Y = parseFloat(Y_num.value), Z = parseFloat(Z_num.value);
      // Convert to RGB
      let [r,g,b] = xyzToRgb(X,Y,Z);
      // Check clamp
      const clamped = (r<0 || r>255 || g<0 || g>255 || b<0 || b>255);
      let rr = Math.round(clamp(r,0,255)), gg = Math.round(clamp(g,0,255)), bb = Math.round(clamp(b,0,255));
      const hex = '#'+[rr,gg,bb].map(x=>x.toString(16).padStart(2,'0')).join('');
      swatch.style.background = hex; colorPicker.value = hex;

      // XYZ -> LAB
      const [L,a,b_] = xyzToLab(X,Y,Z);
      const [H,HL,S] = rgbToHsl(rr,gg,bb);
      // Update fields
      L_range.value = L.toFixed(2); L_num.value = L.toFixed(2);
      a_range.value = a.toFixed(2); a_num.value = a.toFixed(2);
      b_range.value = b_.toFixed(2); b_num.value = b_.toFixed(2);
      H_range.value = H.toFixed(2); H_num.value = H.toFixed(2);
      HL_range.value = HL.toFixed(2); HL_num.value = HL.toFixed(2);
      S_range.value = S.toFixed(2); S_num.value = S.toFixed(2);

      updating = false;
      clampNotice.textContent = clamped ? 'Происходит обрезание при переходе XYZ→RGB' : '';
    }

    function setColorFromLab(){
      if(updating) return; updating = true;
      let L = parseFloat(L_num.value), a = parseFloat(a_num.value), b_ = parseFloat(b_num.value);
      let [X,Y,Z] = labToXyz(L,a,b_);
      X_range.value = X.toFixed(2); X_num.value = X.toFixed(2);
      Y_range.value = Y.toFixed(2); Y_num.value = Y.toFixed(2);
      Z_range.value = Z.toFixed(2); Z_num.value = Z.toFixed(2);

      let [r,g,b] = xyzToRgb(X,Y,Z);
      const clamped = (r<0 || r>255 || g<0 || g>255 || b<0 || b>255);
      let rr = Math.round(clamp(r,0,255)), gg = Math.round(clamp(g,0,255)), bb = Math.round(clamp(b,0,255));
      const hex = '#'+[rr,gg,bb].map(x=>x.toString(16).padStart(2,'0')).join('');
      swatch.style.background = hex; colorPicker.value = hex;

      const [H,HL,S] = rgbToHsl(rr,gg,bb);
      H_range.value = H.toFixed(2); H_num.value = H.toFixed(2);
      HL_range.value = HL.toFixed(2); HL_num.value = HL.toFixed(2);
      S_range.value = S.toFixed(2); S_num.value = S.toFixed(2);

      updating = false;
      clampNotice.textContent = clamped ? 'Происходит обрезание при переходе LAB→RGB' : '';
    }

    function setColorFromHls(){
      if(updating) return; updating = true;
      let H = parseFloat(H_num.value), HL = parseFloat(HL_num.value), S = parseFloat(S_num.value);
      let [r,g,b] = hslToRgb(H,S,HL);
      let rr = Math.round(clamp(r,0,255)), gg = Math.round(clamp(g,0,255)), bb = Math.round(clamp(b,0,255));
      const hex = '#'+[rr,gg,bb].map(x=>x.toString(16).padStart(2,'0')).join('');
      swatch.style.background = hex; colorPicker.value = hex;

      const [X,Y,Z] = rgbToXyz(rr,gg,bb);
      X_range.value = X.toFixed(2); X_num.value = X.toFixed(2);
      Y_range.value = Y.toFixed(2); Y_num.value = Y.toFixed(2);
      Z_range.value = Z.toFixed(2); Z_num.value = Z.toFixed(2);
      const [L,a,b_] = xyzToLab(X,Y,Z);
      L_range.value = L.toFixed(2); L_num.value = L.toFixed(2);
      a_range.value = a.toFixed(2); a_num.value = a.toFixed(2);
      b_range.value = b_.toFixed(2); b_num.value = b_.toFixed(2);

      updating = false;
      clampNotice.textContent = '';
    }

    // link inputs
    link(X_range, X_num, setColorFromXyz);
    link(Y_range, Y_num, setColorFromXyz);
    link(Z_range, Z_num, setColorFromXyz);

    link(L_range, L_num, setColorFromLab);
    link(a_range, a_num, setColorFromLab);
    link(b_range, b_num, setColorFromLab);

    link(H_range, H_num, setColorFromHls);
    link(HL_range, HL_num, setColorFromHls);
    link(S_range, S_num, setColorFromHls);

    // color picker
    colorPicker.addEventListener('input', ()=>{
      const hex = colorPicker.value;
      const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
      setColorFromRgb(r,g,b, 'picker');
    });

    // init with neutral gray
    setColorFromRgb(120,120,120);

  </script>
</body>
</html>
